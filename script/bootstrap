#!/bin/sh
#
# Punica - LwM2M server with REST API
# Copyright (C) 2018 8devices
#
# This program is free software: you can redistribute it and/or modify it
# under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License,
# or (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
# See the GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program. If not, see <https://www.gnu.org/licenses/>.
#

set -e

PROJECT_ROOT_DIR="$(cd $(dirname "$0")/.. && pwd -P)"

SCRIPT_NAME=$(basename -- "$0")
TIMESTAMP=$(date +"%Y-%m-%d_%H-%M-%S")
LOG_FILE="${PROJECT_ROOT_DIR}/${SCRIPT_NAME}_${TIMESTAMP}.log"

JANSSON_DIR="${PROJECT_ROOT_DIR}/third_party/jansson"
LIBJWT_DIR="${PROJECT_ROOT_DIR}/third_party/libjwt"
LIBMICROHTTPD_DIR="${PROJECT_ROOT_DIR}/third_party/libmicrohttpd"
GNUTLS_DIR="${PROJECT_ROOT_DIR}/third_party/gnutls"
ULFFIUS_DIR="${PROJECT_ROOT_DIR}/third_party/ulfius"
WAKAAMA_DIR="${PROJECT_ROOT_DIR}/third_party/wakaama"

echo_stderr () {
    echo "$@" >&2
}

library_error () {
    echo_stderr "Failed to install $1!"
    echo_stderr ""
    echo_stderr "For more information refer to \"${LOG_FILE}\""

    exit 1
}

update_repositories () {
    if which apt-get; then
        sudo apt-get update -qq
    elif which rpm; then
        echo_stderr "RPM is not supported yet!"
        return 1
    elif which opkg; then
        echo_stderr "OPKG is not supported yet!"
        return 1
    elif which brew; then
        echo_stderr "BREW is not supported yet!"
        return 1
    else
        echo_stderr "Unknown package manager! (not supported yet)"
        return 1
    fi

    return 0
}

update_submodules () {
    eval "cd ${PROJECT_ROOT_DIR}"
    git submodule update --init --recursive --remote >> ${LOG_FILE} 2>&1 ||
    (
        echo_stderr "Failed to update submodules!"
        return 1
    )

    cd -
}

install_submodules () {
    install_libjansson
    install_gnutls
    install_libmicrohttpd
    install_libjwt
    install_ulfius
    install_wakaama
}

install_build_tools () {
    if which apt-get; then
        sudo apt-get install -yqq git cmake build-essential automake libtool
    elif which rpm; then
        echo_stderr "RPM is not supported yet!"
        return 1
    elif which opkg; then
        echo_stderr "OPKG is not supported yet!"
        return 1
    elif which brew; then
        echo_stderr "BREW is not supported yet!"
        return 1
    else
        echo_stderr "Unknown package manager! (not supported yet)"
        return 1
    fi

    return $?
}

install_wakaama () {
    echo "    - Installing wakaama..."

    {
        eval "${WAKAAMA_DIR}/script/setup" &&
        eval "cd ${WAKAAMA_DIR}/build" &&
        sudo make install &&
        cd -
    } >> ${LOG_FILE} 2>&1 || {
        library_error "wakaama"
        return 1
    }
}

install_libjansson () {
    echo "    - Installing libjansson..."
    eval "cd ${JANSSON_DIR}"

    {
        autoreconf -i &&
        ./configure &&
        make &&
        sudo make install
        cd -
    } >> ${LOG_FILE} 2>&1 || {
        library_error "libjansson"
        return 1
    }
}

install_gnutls () {
    echo "    - Installing gnutls..."
    eval "cd ${GNUTLS_DIR}"
    configure_args="--with-included-libtasn1 --with-included-unistring --disable-tests --enable-static --disable-doc"

    {
        ./bootstrap &&
        eval "./configure ${configure_args}" &&
        make &&
        sudo make install &&
        cd -
    } >> ${LOG_FILE} 2>&1 || {
        library_error "gnutls"
        return 1
    }
}

install_libjwt () {
    echo "    - Installing libjwt..."
    eval "cd ${LIBJWT_DIR}"

    {
        autoreconf -i &&
        ./configure --without-openssl &&
        make all &&
        sudo make install
        cd -
    } >> ${LOG_FILE} 2>&1 || {
        library_error "libjwt"
        return 1
    }
}

install_libmicrohttpd () {
    echo "    - Installing libmicrohttpd..."
    eval "cd ${LIBMICROHTTPD_DIR}"

    {
        autoreconf -i &&
        ./configure &&
        make &&
        sudo make install
        cd -
    } >> ${LOG_FILE} 2>&1 || {
        library_error "libmicrohttpd"
        return 1
    }
}

install_ulfius () {
    echo "    - Installing ulfius..."
    if [ -d "${ULFFIUS_DIR}/build" ]; then
        eval "cd ${ULFFIUS_DIR}/build"
        make clear >> ${LOG_FILE} 2>&1 || true
    else
        eval "mkdir ${ULFFIUS_DIR}/build"
        eval "cd ${ULFFIUS_DIR}/build"
    fi

    {
        cmake ../ &&
        make &&
        sudo make install
        cd -
    } >> ${LOG_FILE} 2>&1 || {
        library_error "ulfius"
        return 1
    }
}

echo "==> Updating package lists..."
update_repositories >> ${LOG_FILE}

echo "==> Installing building tools..."
install_build_tools >> ${LOG_FILE}

echo "==> Updating submodules..."
update_submodules >> ${LOG_FILE}

echo "==> Installing submodules..."
install_submodules

echo "Finished bootstrapping!"
